<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Memory - ×”×–×™×›×¨×•×Ÿ ×”×—×›× ×©×œ×š</title>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Heebo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
        }

        .logo-icon {
            width: 45px;
            height: 45px;
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .logo p {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .add-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-family: 'Heebo', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        /* Search & Filter */
        .search-section {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .search-box {
            background: white;
            border-radius: 15px;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .search-box input {
            flex: 1;
            border: none;
            font-size: 1rem;
            font-family: 'Heebo', sans-serif;
            outline: none;
        }

        .search-box input::placeholder {
            color: #aaa;
        }

        .search-icon {
            color: #667eea;
            font-size: 1.2rem;
        }

        /* Categories */
        .categories {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .category-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid transparent;
            padding: 8px 20px;
            border-radius: 20px;
            font-family: 'Heebo', sans-serif;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-btn:hover,
        .category-btn.active {
            background: white;
            color: #667eea;
        }

        /* Memories Grid */
        .memories-container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px 40px;
        }

        .memories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .memory-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .memory-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 50px rgba(0,0,0,0.15);
        }

        .memory-thumbnail {
            height: 160px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
        }

        .memory-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .memory-content {
            padding: 20px;
        }

        .memory-category {
            display: inline-block;
            background: #f0f0ff;
            color: #667eea;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .memory-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .memory-url {
            font-size: 0.85rem;
            color: #888;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .memory-date {
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 10px;
        }

        .memory-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .memory-action-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 8px;
            font-family: 'Heebo', sans-serif;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .memory-action-btn.open {
            background: #667eea;
            color: white;
        }

        .memory-action-btn.share {
            background: #f0f0f0;
            color: #333;
        }

        .memory-action-btn.delete {
            background: #fee;
            color: #e55;
        }

        .memory-action-btn:hover {
            opacity: 0.9;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: white;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .empty-state h2 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .empty-state p {
            opacity: 0.8;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            transform: translateY(20px);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #eee;
            border-radius: 10px;
            font-family: 'Heebo', sans-serif;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-family: 'Heebo', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .modal-btn.save {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .modal-btn.cancel {
            background: #f0f0f0;
            color: #333;
        }

        .modal-btn:hover {
            opacity: 0.9;
        }

        /* Stats */
        .stats {
            max-width: 1200px;
            margin: 0 auto 20px;
            padding: 0 20px;
            color: white;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            .memories-grid {
                grid-template-columns: 1fr;
            }

            .add-btn span {
                display: none;
            }
        }

        /* Category Icons */
        .cat-icon {
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">ğŸ§ </div>
                <div>
                    <h1>AI Memory</h1>
                    <p>×”×–×™×›×¨×•×Ÿ ×”×—×›× ×©×œ×š</p>
                </div>
            </div>
            <button class="add-btn" onclick="openModal()">
                <span>â•</span>
                <span>×©××™×¨×” ×—×“×©×”</span>
            </button>
        </div>
    </header>

    <!-- Search -->
    <section class="search-section">
        <div class="search-box">
            <span class="search-icon">ğŸ”</span>
            <input type="text" id="searchInput" placeholder="×—×™×¤×•×© ×‘×–×™×›×¨×•× ×•×ª..." oninput="filterMemories()">
        </div>
    </section>

    <!-- Categories -->
    <div class="categories">
        <button class="category-btn active" data-category="all" onclick="setCategory('all')">
            <span class="cat-icon">ğŸ“</span> ×”×›×œ
        </button>
        <button class="category-btn" data-category="video" onclick="setCategory('video')">
            <span class="cat-icon">ğŸ¬</span> ×¡×¨×˜×•× ×™×
        </button>
        <button class="category-btn" data-category="website" onclick="setCategory('website')">
            <span class="cat-icon">ğŸŒ</span> ××ª×¨×™×
        </button>
        <button class="category-btn" data-category="document" onclick="setCategory('document')">
            <span class="cat-icon">ğŸ“„</span> ××¡××›×™×
        </button>
        <button class="category-btn" data-category="invoice" onclick="setCategory('invoice')">
            <span class="cat-icon">ğŸ§¾</span> ×—×©×‘×•× ×™×•×ª
        </button>
        <button class="category-btn" data-category="image" onclick="setCategory('image')">
            <span class="cat-icon">ğŸ“¸</span> ×ª××•× ×•×ª
        </button>
        <button class="category-btn" data-category="other" onclick="setCategory('other')">
            <span class="cat-icon">ğŸ“Œ</span> ××—×¨
        </button>
    </div>

    <!-- Stats -->
    <div class="stats">
        <span id="statsText">×˜×•×¢×Ÿ...</span>
    </div>

    <!-- Memories Grid -->
    <main class="memories-container">
        <div class="memories-grid" id="memoriesGrid">
            <!-- Cards will be inserted here -->
        </div>

        <div class="empty-state" id="emptyState" style="display: none;">
            <div class="empty-state-icon">ğŸ§ </div>
            <h2>××™×Ÿ ×¢×“×™×™×Ÿ ×–×™×›×¨×•× ×•×ª</h2>
            <p>×”×ª×—×œ ×œ×©××•×¨ ×ª×•×›×Ÿ ×¢× ×›×¤×ª×•×¨ "×©××™×¨×” ×—×“×©×”"</p>
        </div>
    </main>

    <!-- Add Modal -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <h2>ğŸ’¾ ×©××™×¨×” ×—×“×©×”</h2>
            <form id="memoryForm" onsubmit="saveMemory(event)">
                <div class="form-group">
                    <label>×›×•×ª×¨×ª *</label>
                    <input type="text" id="titleInput" required placeholder="×ª×Ÿ ×©× ×œ×–×™×›×¨×•×Ÿ">
                </div>
                <div class="form-group">
                    <label>×§×™×©×•×¨ (URL)</label>
                    <input type="url" id="urlInput" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label>×§×˜×’×•×¨×™×”</label>
                    <select id="categoryInput">
                        <option value="other">ğŸ“Œ ××—×¨</option>
                        <option value="video">ğŸ¬ ×¡×¨×˜×•×Ÿ</option>
                        <option value="website">ğŸŒ ××ª×¨</option>
                        <option value="document">ğŸ“„ ××¡××š</option>
                        <option value="invoice">ğŸ§¾ ×—×©×‘×•× ×™×ª</option>
                        <option value="image">ğŸ“¸ ×ª××•× ×”</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>×”×¢×¨×•×ª</label>
                    <textarea id="notesInput" placeholder="×”×¢×¨×•×ª × ×•×¡×¤×•×ª..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button>
                    <button type="submit" class="modal-btn save">×©××•×¨</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://wdpatppnndvnoakbdhgm.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_gIh-XYn2_25uEVQ_KEElFQ_4XVvX6bi';

        // State
        let memories = [];
        let currentCategory = 'all';
        let searchQuery = '';

        // Category config
        const categoryConfig = {
            video: { icon: 'ğŸ¬', label: '×¡×¨×˜×•×Ÿ', color: '#e74c3c' },
            website: { icon: 'ğŸŒ', label: '××ª×¨', color: '#3498db' },
            document: { icon: 'ğŸ“„', label: '××¡××š', color: '#9b59b6' },
            invoice: { icon: 'ğŸ§¾', label: '×—×©×‘×•× ×™×ª', color: '#27ae60' },
            image: { icon: 'ğŸ“¸', label: '×ª××•× ×”', color: '#f39c12' },
            other: { icon: 'ğŸ“Œ', label: '××—×¨', color: '#95a5a6' }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadMemories();

            // Check for shared content (from URL params)
            const urlParams = new URLSearchParams(window.location.search);
            let sharedUrl = urlParams.get('url');
            const sharedFile = urlParams.get('file');
            const sharedFileName = urlParams.get('name');

            // Also check for URL in hash (backup method)
            if (!sharedUrl && window.location.hash) {
                sharedUrl = window.location.hash.substring(1);
            }

            // Decode URL if needed
            if (sharedUrl) {
                try {
                    sharedUrl = decodeURIComponent(sharedUrl);
                } catch(e) {}
            }

            console.log('Shared URL:', sharedUrl); // Debug
            console.log('Shared File:', sharedFile ? 'Yes' : 'No'); // Debug

            if (sharedFile && sharedFileName) {
                // Handle file upload
                autoSaveFile(sharedFile, sharedFileName);
            } else if (sharedUrl) {
                // Auto-save immediately with smart title
                autoSaveMemory(sharedUrl);
            }
        });

        // Auto-save with smart title generation
        async function autoSaveMemory(url) {
            const category = detectCategory(url);
            const smartTitle = generateSmartTitle(url);
            const thumbnail = getThumbnail(url);

            const memory = {
                title: smartTitle,
                url: url,
                category: category,
                thumbnail: thumbnail,
                notes: null
            };

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/memories`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(memory)
                });

                if (!response.ok) throw new Error('Failed to save');

                const newMemory = await response.json();
                memories.unshift(newMemory[0]);
                renderMemories();

                // Show success message
                showToast('× ×©××¨ ×‘×”×¦×œ×—×”! âœ“');

                // Clear URL params
                window.history.replaceState({}, document.title, window.location.pathname);

            } catch (error) {
                console.error('Error auto-saving:', error);
                showToast('×©×’×™××” ×‘×©××™×¨×”');
            }
        }

        // Auto-save file (from Base64)
        async function autoSaveFile(base64Data, fileName) {
            showToast('××¢×œ×” ×§×•×‘×¥...');

            try {
                // Decode base64 to binary
                const binaryString = atob(base64Data);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                const blob = new Blob([bytes]);

                // Generate unique filename
                const uniqueName = Date.now() + '_' + fileName;

                // Upload to Supabase Storage
                const uploadResponse = await fetch(
                    `${SUPABASE_URL}/storage/v1/object/files/${uniqueName}`,
                    {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Content-Type': 'application/octet-stream'
                        },
                        body: blob
                    }
                );

                if (!uploadResponse.ok) throw new Error('Upload failed');

                // Get public URL
                const fileUrl = `${SUPABASE_URL}/storage/v1/object/public/files/${uniqueName}`;

                // Detect category from filename
                const category = detectCategoryFromFileName(fileName);
                const smartTitle = generateFileTitle(fileName);

                // Save memory with file reference
                const memory = {
                    title: smartTitle,
                    url: fileUrl,
                    category: category,
                    thumbnail: getFileThumbnail(fileName, fileUrl),
                    notes: `×§×•×‘×¥: ${fileName}`
                };

                const response = await fetch(`${SUPABASE_URL}/rest/v1/memories`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(memory)
                });

                if (!response.ok) throw new Error('Failed to save');

                const newMemory = await response.json();
                memories.unshift(newMemory[0]);
                renderMemories();

                showToast('×§×•×‘×¥ × ×©××¨ ×‘×”×¦×œ×—×”! âœ“');
                window.history.replaceState({}, document.title, window.location.pathname);

            } catch (error) {
                console.error('Error saving file:', error);
                showToast('×©×’×™××” ×‘×©××™×¨×ª ×”×§×•×‘×¥');
            }
        }

        // Detect category from filename
        function detectCategoryFromFileName(fileName) {
            const lower = fileName.toLowerCase();
            if (lower.endsWith('.pdf') || lower.endsWith('.doc') || lower.endsWith('.docx')) return 'document';
            if (lower.endsWith('.xls') || lower.endsWith('.xlsx')) return 'document';
            if (lower.endsWith('.jpg') || lower.endsWith('.jpeg') || lower.endsWith('.png') || lower.endsWith('.gif')) return 'image';
            if (lower.includes('invoice') || lower.includes('receipt') || lower.includes('×—×©×‘×•× ×™×ª')) return 'invoice';
            return 'document';
        }

        // Generate smart title from filename
        function generateFileTitle(fileName) {
            // Remove extension
            const nameWithoutExt = fileName.replace(/\.[^/.]+$/, '');
            // Clean up
            const cleanName = nameWithoutExt.replace(/[_-]/g, ' ').trim();
            return cleanName || '×§×•×‘×¥ ×—×“×©';
        }

        // Get thumbnail for file
        function getFileThumbnail(fileName, fileUrl) {
            const lower = fileName.toLowerCase();
            // For images, use the file itself as thumbnail
            if (lower.endsWith('.jpg') || lower.endsWith('.jpeg') || lower.endsWith('.png') || lower.endsWith('.gif')) {
                return fileUrl;
            }
            // For PDFs and docs, we can't easily generate thumbnails
            return null;
        }

        // Detect category from URL
        function detectCategory(url) {
            const urlLower = url.toLowerCase();
            const videoSites = ['youtube.com', 'youtu.be', 'vimeo.com', 'tiktok.com', 'instagram.com/reel', 'facebook.com/watch'];
            const docExtensions = ['.pdf', '.doc', '.docx', '.xls', '.xlsx', '.ppt', '.pptx'];
            const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp'];

            if (videoSites.some(site => urlLower.includes(site))) return 'video';
            if (docExtensions.some(ext => urlLower.endsWith(ext))) return 'document';
            if (imageExtensions.some(ext => urlLower.endsWith(ext))) return 'image';
            if (urlLower.includes('invoice') || urlLower.includes('receipt')) return 'invoice';
            return 'website';
        }

        // Generate smart title from URL
        function generateSmartTitle(url) {
            try {
                const urlObj = new URL(url);
                const hostname = urlObj.hostname.replace('www.', '');
                const pathname = urlObj.pathname;

                // YouTube
                if (hostname.includes('youtube.com') || hostname.includes('youtu.be')) {
                    return '×¡×¨×˜×•×Ÿ YouTube';
                }
                // Instagram
                if (hostname.includes('instagram.com')) {
                    if (pathname.includes('/reel/')) return 'Reel ×××™× ×¡×˜×’×¨×';
                    if (pathname.includes('/p/')) return '×¤×•×¡×˜ ×××™× ×¡×˜×’×¨×';
                    return '×ª×•×›×Ÿ ×××™× ×¡×˜×’×¨×';
                }
                // TikTok
                if (hostname.includes('tiktok.com')) {
                    return '×¡×¨×˜×•×Ÿ TikTok';
                }
                // Facebook
                if (hostname.includes('facebook.com')) {
                    return '×ª×•×›×Ÿ ××¤×™×™×¡×‘×•×§';
                }
                // Twitter/X
                if (hostname.includes('twitter.com') || hostname.includes('x.com')) {
                    return '×¦×™×•×¥ ×-X';
                }
                // LinkedIn
                if (hostname.includes('linkedin.com')) {
                    return '×¤×•×¡×˜ ××œ×™× ×§×“××™×Ÿ';
                }
                // General website
                return `×©××™×¨×” ×-${hostname}`;
            } catch (e) {
                return '×©××™×¨×” ×—×“×©×”';
            }
        }

        // Get thumbnail for any URL
        function getThumbnail(url) {
            try {
                const urlObj = new URL(url);
                const hostname = urlObj.hostname.replace('www.', '');

                // YouTube - use native thumbnail
                if (hostname.includes('youtube.com')) {
                    const videoId = urlObj.searchParams.get('v');
                    if (videoId) return `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
                }
                if (hostname.includes('youtu.be')) {
                    const videoId = urlObj.pathname.slice(1);
                    if (videoId) return `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
                }

                // Vimeo - use thum.io
                if (hostname.includes('vimeo.com')) {
                    return `https://image.thum.io/get/width/400/${url}`;
                }

                // For all other URLs - use thum.io screenshot service (free, unlimited)
                return `https://image.thum.io/get/width/400/${url}`;

            } catch (e) {
                return null;
            }
        }

        // Toast notification
        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 30px;
                left: 50%;
                transform: translateX(-50%);
                background: #333;
                color: white;
                padding: 15px 30px;
                border-radius: 25px;
                font-size: 1rem;
                z-index: 9999;
                animation: fadeInUp 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        // Auto-detect category based on URL
        function autoDetectCategory(url) {
            if (!url) return;

            const videoSites = ['youtube.com', 'youtu.be', 'vimeo.com', 'tiktok.com', 'instagram.com/reel', 'facebook.com/watch'];
            const docExtensions = ['.pdf', '.doc', '.docx', '.xls', '.xlsx', '.ppt', '.pptx'];
            const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp'];

            const urlLower = url.toLowerCase();

            if (videoSites.some(site => urlLower.includes(site))) {
                document.getElementById('categoryInput').value = 'video';
            } else if (docExtensions.some(ext => urlLower.endsWith(ext))) {
                document.getElementById('categoryInput').value = 'document';
            } else if (imageExtensions.some(ext => urlLower.endsWith(ext))) {
                document.getElementById('categoryInput').value = 'image';
            } else if (urlLower.includes('invoice') || urlLower.includes('receipt') || urlLower.includes('×—×©×‘×•× ×™×ª')) {
                document.getElementById('categoryInput').value = 'invoice';
            } else {
                document.getElementById('categoryInput').value = 'website';
            }
        }

        // Load memories from Supabase
        async function loadMemories() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/memories?select=*&order=created_at.desc`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load');

                memories = await response.json();
                renderMemories();
            } catch (error) {
                console.error('Error loading memories:', error);
                document.getElementById('statsText').textContent = '×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×';
            }
        }

        // Save new memory
        async function saveMemory(event) {
            event.preventDefault();

            const memory = {
                title: document.getElementById('titleInput').value,
                url: document.getElementById('urlInput').value || null,
                category: document.getElementById('categoryInput').value,
                notes: document.getElementById('notesInput').value || null
            };

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/memories`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(memory)
                });

                if (!response.ok) throw new Error('Failed to save');

                const newMemory = await response.json();
                memories.unshift(newMemory[0]);
                renderMemories();
                closeModal();
                document.getElementById('memoryForm').reset();
            } catch (error) {
                console.error('Error saving memory:', error);
                alert('×©×’×™××” ×‘×©××™×¨×”. × ×¡×” ×©×•×‘.');
            }
        }

        // Delete memory
        async function deleteMemory(id, event) {
            event.stopPropagation();

            if (!confirm('×œ××—×•×§ ××ª ×”×–×™×›×¨×•×Ÿ ×”×–×”?')) return;

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/memories?id=eq.${id}`, {
                    method: 'DELETE',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });

                if (!response.ok) throw new Error('Failed to delete');

                memories = memories.filter(m => m.id !== id);
                renderMemories();
            } catch (error) {
                console.error('Error deleting memory:', error);
                alert('×©×’×™××” ×‘××—×™×§×”. × ×¡×” ×©×•×‘.');
            }
        }

        // Share memory
        function shareMemory(memory, event) {
            event.stopPropagation();

            const text = `${memory.title}\n${memory.url || ''}`;

            if (navigator.share) {
                navigator.share({
                    title: memory.title,
                    url: memory.url
                });
            } else {
                navigator.clipboard.writeText(text);
                alert('×”×§×™×©×•×¨ ×”×•×¢×ª×§!');
            }
        }

        // Open URL
        function openUrl(url, event) {
            event.stopPropagation();
            if (url) window.open(url, '_blank');
        }

        // Render memories
        function renderMemories() {
            const grid = document.getElementById('memoriesGrid');
            const emptyState = document.getElementById('emptyState');

            // Filter
            let filtered = memories;

            if (currentCategory !== 'all') {
                filtered = filtered.filter(m => m.category === currentCategory);
            }

            if (searchQuery) {
                const query = searchQuery.toLowerCase();
                filtered = filtered.filter(m =>
                    m.title.toLowerCase().includes(query) ||
                    (m.url && m.url.toLowerCase().includes(query)) ||
                    (m.notes && m.notes.toLowerCase().includes(query))
                );
            }

            // Update stats
            document.getElementById('statsText').textContent =
                `${filtered.length} ×–×™×›×¨×•× ×•×ª ${currentCategory !== 'all' ? '×‘×§×˜×’×•×¨×™×”' : '×¡×”"×›'}`;

            if (filtered.length === 0) {
                grid.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            grid.innerHTML = filtered.map(memory => {
                const cat = categoryConfig[memory.category] || categoryConfig.other;
                const date = new Date(memory.created_at).toLocaleDateString('he-IL');

                return `
                    <div class="memory-card" onclick="openUrl('${memory.url || ''}', event)">
                        <div class="memory-thumbnail">
                            ${memory.thumbnail
                                ? `<img src="${memory.thumbnail}" alt="${memory.title}" onerror="this.style.display='none'; this.parentElement.innerHTML='${cat.icon}';">`
                                : cat.icon
                            }
                        </div>
                        <div class="memory-content">
                            <span class="memory-category">${cat.icon} ${cat.label}</span>
                            <h3 class="memory-title">${memory.title}</h3>
                            ${memory.url ? `<p class="memory-url">${memory.url}</p>` : ''}
                            <p class="memory-date">ğŸ“… ${date}</p>
                            <div class="memory-actions">
                                ${memory.url ? `<button class="memory-action-btn open" onclick="openUrl('${memory.url}', event)">×¤×ª×—</button>` : ''}
                                <button class="memory-action-btn share" onclick="shareMemory(${JSON.stringify(memory).replace(/"/g, '&quot;')}, event)">×©×ª×£</button>
                                <button class="memory-action-btn delete" onclick="deleteMemory('${memory.id}', event)">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Filter functions
        function setCategory(category) {
            currentCategory = category;
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.category === category);
            });
            renderMemories();
        }

        function filterMemories() {
            searchQuery = document.getElementById('searchInput').value;
            renderMemories();
        }

        // Modal functions
        function openModal() {
            document.getElementById('modalOverlay').classList.add('active');
        }

        function closeModal(event) {
            if (!event || event.target === document.getElementById('modalOverlay')) {
                document.getElementById('modalOverlay').classList.remove('active');
            }
        }
    </script>
</body>
</html>
